<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Toolkit - Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366F1; --primary-dark: #4F46E5; --primary-glow: rgba(99, 102, 241, 0.15);
            --success: #10B981; --warning: #F59E0B; --danger: #EF4444;
            --bg-app: #F3F4F6; --bg-card: #FFFFFF; --bg-input: #F9FAFB;
            --text-main: #111827; --text-muted: #6B7280; --border: #E5E7EB;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --slider-track: #E5E7EB;
            
            /* Visual Diff Colors */
            --trad-bg: #EEF2FF; --trad-border: #6366F1;
            --mf-bg: #ECFDF5; --mf-border: #10B981;
        }
        [data-theme="dark"] {
            --bg-app: #0F172A; --bg-card: #1E293B; --bg-input: #0F172A;
            --text-main: #F8FAFC; --text-muted: #94A3B8; --border: #334155;
            --slider-track: #334155;
            
            --trad-bg: #1E1B4B; --trad-border: #6366F1;
            --mf-bg: #064E3B; --mf-border: #10B981;
        }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-app); color: var(--text-main); margin: 0; padding: 20px; transition: 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: var(--bg-card); border-radius: 20px; box-shadow: var(--shadow-md); border: 1px solid var(--border); }
        h1 { font-size: 1.5rem; font-weight: 800; margin: 0; background: linear-gradient(135deg, var(--primary), #A855F7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .theme-btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 10px 16px; border-radius: 12px; cursor: pointer; font-weight: 600; }

        /* Tabs */
        .tabs-container { display: flex; gap: 5px; margin-bottom: 30px; overflow-x: auto; background: var(--bg-card); padding: 6px; border-radius: 16px; border: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; color: var(--text-muted); font-weight: 600; border-radius: 12px; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px var(--primary-glow); }

        /* Layout */
        .calc-grid { display: none; grid-template-columns: 380px 1fr; gap: 30px; align-items: start; animation: fadeIn 0.4s ease-out; }
        .calc-grid.active { display: grid; }
        @media (max-width: 1024px) { .calc-grid.active { grid-template-columns: 1fr; } }

        /* Panels */
        .panel { background: var(--bg-card); border-radius: 24px; padding: 25px; box-shadow: var(--shadow-md); border: 1px solid var(--border); }
        .panel-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .panel-title::before { content: ''; width: 6px; height: 6px; background: var(--primary); border-radius: 50%; display: block; }

        /* Inputs */
        .input-group { margin-bottom: 20px; }
        .label-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; font-weight: 600; color: var(--text-muted); }
        .input-field { width: 100%; padding: 12px 16px; border-radius: 12px; border: 2px solid var(--bg-input); background: var(--bg-input); color: var(--text-main); font-weight: 700; text-align: right; font-size: 1rem; }
        .input-field:focus { border-color: var(--primary); background: var(--bg-card); }
        .readonly { background: var(--primary-glow); color: var(--primary); border-color: transparent; }
        .custom-select { width: 100%; padding: 12px 16px; border-radius: 12px; border: 2px solid var(--bg-input); background: var(--bg-input); color: var(--text-main); font-weight: 700; text-align: right; font-size: 1rem; }

        /* Sliders */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; margin-top: 5px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: var(--slider-track); border-radius: 10px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: var(--bg-card); border: 2px solid var(--primary); margin-top: -7px; }

        /* Color Boxes for Smart Plan */
        .trad-box { background: var(--trad-bg); border: 1px solid var(--trad-border); padding: 20px; border-radius: 16px; margin-top: 20px; }
        .mf-box { background: var(--mf-bg); border: 1px solid var(--mf-border); padding: 20px; border-radius: 16px; margin-top: 20px; }

        /* Extra Box (Strategy) */
        .extra-pay-box { background: linear-gradient(145deg, var(--bg-input), var(--bg-card)); border: 1px dashed var(--border); padding: 20px; border-radius: 16px; margin-top: 30px; }
        
        .strategy-toggle { display: flex; gap: 10px; margin-bottom: 15px; background: var(--bg-card); padding: 4px; border-radius: 10px; border: 1px solid var(--border); }
        .strategy-opt { flex: 1; text-align: center; padding: 8px; font-size: 0.8rem; font-weight: 700; cursor: pointer; border-radius: 8px; color: var(--text-muted); transition: 0.2s; }
        .strategy-opt.selected { background: var(--success); color: white; box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3); }
        .radio-group { display: flex; gap: 15px; align-items: center; margin-bottom: 10px; font-size: 0.9rem; font-weight: 600; color: var(--text-muted); }
        
        .btn-add { width: 100%; padding: 12px; background: var(--text-main); color: var(--bg-card); border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .tag { display: flex; justify-content: space-between; background: var(--bg-card); border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; margin-top: 8px; font-size: 0.85rem; font-weight: 600; }
        .tag-close { color: var(--danger); cursor: pointer; }

        /* Results */
        .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--bg-input); border-radius: 16px; padding: 20px; text-align: center; border: 1px solid transparent; }
        .stat-label { display: block; font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; font-weight: 600; }
        .stat-value { font-size: 1.25rem; font-weight: 800; color: var(--text-main); }
        .text-green { color: var(--success); } .text-gradient { background: linear-gradient(135deg, var(--primary), #A855F7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .text-purple { color: #6366F1; }

        .chart-container { position: relative; height: 320px; width: 100%; margin: 10px 0; }
        .table-scroll { max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 16px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: var(--bg-input); padding: 16px; text-align: right; font-weight: 700; color: var(--text-muted); position: sticky; top: 0; z-index: 2; border-bottom: 1px solid var(--border); }
        td { padding: 12px 16px; text-align: right; border-bottom: 1px solid var(--border); font-variant-numeric: tabular-nums; }
        th:first-child, td:first-child { text-align: left; }
        .hl-row { background: rgba(16, 185, 129, 0.1); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="brand"><h1>Fintech Pro</h1><p>Smart Pre-Closure & Wealth Engine</p></div>
        <button class="theme-btn" onclick="toggleTheme()">‚òÄ / üåô</button>
    </header>

    <div class="tabs-container">
        <button class="tab-btn active" onclick="switchTab('smartplan')">Smart Plan</button>
        <button class="tab-btn" onclick="switchTab('realestate')">Real Estate</button>
        <button class="tab-btn" onclick="switchTab('loan')">Home Loan</button>
        <button class="tab-btn" onclick="switchTab('sip')">SIP</button>
        <button class="tab-btn" onclick="switchTab('swp')">SWP</button>
        <button class="tab-btn" onclick="switchTab('lumpsum')">Lumpsum</button>
    </div>

    <div id="smartplan" class="calc-grid active">
        <div class="panel">
            <div class="panel-title">Plan Config</div>
            <div class="input-group">
                <div class="label-row"><span>Monthly Investment</span></div>
                <input type="number" class="input-field" id="smart_amt_num" value="10000" oninput="sync('smart_amt', 'num')">
                <input type="range" id="smart_amt_rng" min="1000" max="100000" step="500" value="10000" oninput="sync('smart_amt', 'rng')">
            </div>
            
            <div class="input-group">
                <div class="label-row"><span>Investment Years (Pay)</span></div>
                <input type="number" class="input-field" id="smart_inv_yrs_num" value="10" oninput="calculateSmartPlan('base')">
                <input type="range" id="smart_inv_yrs_rng" min="1" max="40" step="1" value="10" oninput="calculateSmartPlan('base')">
            </div>
            
            <div class="input-group">
                <div class="label-row"><span>Freeze/Wait Years (Hold)</span></div>
                <input type="number" class="input-field" id="smart_wait_yrs_num" value="5" oninput="calculateSmartPlan('base')">
                <input type="range" id="smart_wait_yrs_rng" min="0" max="30" step="1" value="5" oninput="calculateSmartPlan('base')">
                <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px; text-align:right;">Total Duration: <span id="smart_total_dur">15</span> Years</div>
            </div>

            <div class="trad-box">
                <div class="label-row" style="margin-bottom:15px; color:var(--primary); font-weight:800;"><strong>üèõÔ∏è Traditional Plan (Auto-Sync)</strong></div>
                <div class="input-group">
                    <div class="label-row"><span>Assured Maturity Amount</span><span style="font-size:0.7rem;">Calculates ROI</span></div>
                    <input type="number" class="input-field" id="smart_plan_amount_num" placeholder="e.g. 2500000" oninput="calculateSmartPlan('amount_num')">
                    <input type="range" id="smart_plan_amount_rng" min="100000" max="20000000" step="50000" value="2500000" oninput="calculateSmartPlan('amount_rng')">
                </div>
                <div class="input-group">
                    <div class="label-row"><span>Implied ROI (%)</span><span style="font-size:0.7rem;">Calculates Amount</span></div>
                    <input type="number" class="input-field" id="smart_plan_rate_num" value="6" oninput="calculateSmartPlan('rate_num')">
                    <input type="range" id="smart_plan_rate_rng" min="1" max="15" step="0.1" value="6" oninput="calculateSmartPlan('rate_rng')">
                </div>
            </div>

            <div class="mf-box">
                <div class="label-row" style="margin-bottom:15px; color:var(--success); font-weight:800;"><strong>üìà Compare: Mutual Fund</strong></div>
                <div class="input-group">
                    <div class="label-row"><span>Expected ROI (%)</span></div>
                    <input type="number" class="input-field" id="smart_mf_rate_num" value="12" oninput="sync('smart_mf_rate', 'num')">
                    <input type="range" id="smart_mf_rate_rng" min="5" max="25" step="0.5" value="12" oninput="sync('smart_mf_rate', 'rng')">
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">Smart Comparison</div>
            <div class="summary-grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="stat-card"><span class="stat-label">Total Invested</span><span class="stat-value" id="smart_invested">0</span></div>
                <div class="stat-card"><span class="stat-label">Traditional Maturity</span><span class="stat-value text-purple" id="smart_plan_val">0</span></div>
                <div class="stat-card"><span class="stat-label">Mutual Fund Maturity</span><span class="stat-value text-green" id="smart_mf_val">0</span></div>
                <div class="stat-card" style="background:var(--primary-glow); border:1px solid var(--primary);"><span class="stat-label" style="color:var(--primary)">Wealth Gap</span><span class="stat-value" style="color:var(--primary)" id="smart_gap">0</span></div>
            </div>
            <div class="chart-container"><canvas id="smartChart"></canvas></div>
        </div>
    </div>

    <div id="realestate" class="calc-grid">
        <div class="panel">
            <div class="panel-title">Property Config</div>
            <div class="input-group"><div class="label-row"><span>Area (Sft) / Price</span></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><input type="number" class="input-field" id="re_sft" value="1500" oninput="calculateRealEstate('cost')"><input type="number" class="input-field" id="re_price_sft" value="6500" oninput="calculateRealEstate('cost')"></div></div>
            <div class="input-group"><div class="label-row"><span>Down Payment</span></div><div style="display:grid; grid-template-columns:1fr 100px; gap:10px;"><input type="number" class="input-field" id="re_dp_amt" oninput="syncDP('amt')"><input type="number" class="input-field" id="re_dp_percent" value="20" oninput="syncDP('percent')"></div><input type="range" id="re_dp_rng" min="0" max="90" step="1" value="20" oninput="syncDP('rng')"></div>
            <div class="input-group"><div class="label-row"><span>Rate (%)</span></div><input type="number" class="input-field" id="re_rate_num" value="8.5" oninput="sync('re_rate', 'num')"><input type="range" id="re_rate_rng" min="5" max="15" step="0.1" value="8.5" oninput="sync('re_rate', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Rental Yield (%)</span></div><input type="number" class="input-field" id="re_yield_num" value="3.5" oninput="sync('re_yield', 'num')"><input type="range" id="re_yield_rng" min="1" max="10" step="0.1" value="3.5" oninput="sync('re_yield', 'rng')"></div>
            <div class="extra-pay-box">
                <div class="strategy-toggle"><div class="strategy-opt selected" id="re_strat_tenure" onclick="setStrategy('re', 'tenure')">Reduce Tenure</div><div class="strategy-opt" id="re_strat_emi" onclick="setStrategy('re', 'emi')">Reduce EMI</div></div>
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px;"><input type="number" id="re_part_amt" placeholder="Amount" class="input-field" style="background:var(--bg-card)"><input type="number" id="re_part_year" placeholder="Year" class="input-field" style="background:var(--bg-card)"></div>
                <button class="btn-add" onclick="addPayment('re')">Add Payment</button><div id="re_payments_list"></div>
            </div>
        </div>
        <div class="panel">
            <div class="panel-title">Valuation Analysis</div>
            <div class="summary-grid">
                <div class="stat-card"><span class="stat-label">Total Cost</span><span class="stat-value" id="re_total_cost">0</span></div>
                <div class="stat-card"><span class="stat-label">Prop + 2xRent</span><span class="stat-value text-green" id="re_rent_val">0</span></div>
                <div class="stat-card"><span class="stat-label">Initial EMI</span><span class="stat-value" id="re_emi">0</span></div>
                <div class="stat-card"><span class="stat-label">Interest Saved</span><span class="stat-value text-green" id="re_saved">0</span></div>
            </div>
            <div class="chart-container"><canvas id="reChart"></canvas></div>
            <div class="table-scroll"><table id="re_table"></table></div>
        </div>
    </div>

    <div id="loan" class="calc-grid">
        <div class="panel">
            <div class="panel-title">Loan Config</div>
            <div class="input-group"><div class="label-row"><span>Loan Amount</span></div><input type="number" class="input-field" id="loan_amount_num" value="5000000" oninput="sync('loan_amount', 'num')"><input type="range" id="loan_amount_rng" min="100000" max="20000000" step="50000" value="5000000" oninput="sync('loan_amount', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Rate (%)</span></div><input type="number" class="input-field" id="loan_rate_num" value="8.5" oninput="sync('loan_rate', 'num')"><input type="range" id="loan_rate_rng" min="5" max="20" step="0.1" value="8.5" oninput="sync('loan_rate', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Tenure</span></div><input type="number" class="input-field" id="loan_years_num" value="20" oninput="sync('loan_years', 'num')"><input type="range" id="loan_years_rng" min="1" max="30" step="1" value="20" oninput="sync('loan_years', 'rng')"></div>
            <div class="extra-pay-box">
                <div class="strategy-toggle"><div class="strategy-opt selected" id="loan_strat_tenure" onclick="setStrategy('loan', 'tenure')">Reduce Tenure</div><div class="strategy-opt" id="loan_strat_emi" onclick="setStrategy('loan', 'emi')">Reduce EMI</div></div>
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px;"><input type="number" id="loan_part_amt" placeholder="Amount" class="input-field" style="background:var(--bg-card)"><input type="number" id="loan_part_year" placeholder="Year" class="input-field" style="background:var(--bg-card)"></div>
                <button class="btn-add" onclick="addPayment('loan')">Add Payment</button><div id="loan_payments_list"></div>
            </div>
        </div>
        <div class="panel">
            <div class="panel-title">Repayment</div>
            <div class="summary-grid">
                <div class="stat-card"><span class="stat-label">Initial EMI</span><span class="stat-value text-gradient" id="loan_emi">0</span></div>
                <div class="stat-card"><span class="stat-label">Total Payable</span><span class="stat-value" id="loan_total_pay">0</span></div>
                <div class="stat-card"><span class="stat-label">Interest Saved</span><span class="stat-value text-green" id="loan_saved">0</span></div>
                <div class="stat-card"><span class="stat-label">Time Saved</span><span class="stat-value text-green" id="loan_time_saved">0 Yrs</span></div>
            </div>
            <div class="chart-container"><canvas id="loanChart"></canvas></div>
            <div class="table-scroll"><table id="loan_table"></table></div>
        </div>
    </div>

    <div id="sip" class="calc-grid">
        <div class="panel">
            <div class="panel-title">SIP Details</div>
            <div class="input-group"><div class="label-row"><span>Monthly Inv</span></div><input type="number" class="input-field" id="sip_amount_num" value="5000" oninput="sync('sip_amount', 'num')"><input type="range" id="sip_amount_rng" min="500" max="1000000" step="500" value="5000" oninput="sync('sip_amount', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Return (%)</span></div><input type="number" class="input-field" id="sip_rate_num" value="12" oninput="sync('sip_rate', 'num')"><input type="range" id="sip_rate_rng" min="1" max="30" step="0.5" value="12" oninput="sync('sip_rate', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Years</span></div><input type="number" class="input-field" id="sip_years_num" value="10" oninput="sync('sip_years', 'num')"><input type="range" id="sip_years_rng" min="1" max="40" step="1" value="10" oninput="sync('sip_years', 'rng')"></div>
            <div class="extra-pay-box">
                <label style="display:flex; align-items:center; margin-bottom:10px; font-weight:600;"><input type="checkbox" id="sip_stepup_check" onchange="toggleStepUp()" style="margin-right:10px;"> Enable Step-Up</label>
                <div id="stepup_panel" style="display:none;">
                    <div style="margin-bottom:10px;"><label style="margin-right:15px;"><input type="radio" name="stepup_type" value="percent" checked onclick="calculateSIP()"> %</label><label><input type="radio" name="stepup_type" value="value" onclick="calculateSIP()"> Amount</label></div>
                    <input type="number" class="input-field" id="sip_step_val" value="10" oninput="calculateSIP()">
                </div>
            </div>
        </div>
        <div class="panel">
            <div class="panel-title">Wealth Growth</div>
            <div class="summary-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="stat-card"><span class="stat-label">Total Value</span><span class="stat-value text-gradient" id="sip_total">0</span></div>
                <div class="stat-card"><span class="stat-label">Invested</span><span class="stat-value" id="sip_invested">0</span></div>
                <div class="stat-card"><span class="stat-label">Gains</span><span class="stat-value text-green" id="sip_gains">0</span></div>
            </div>
            <div class="chart-container"><canvas id="sipChart"></canvas></div>
            <div class="table-scroll"><table id="sip_table"></table></div>
        </div>
    </div>

    <div id="swp" class="calc-grid">
        <div class="panel">
            <div class="panel-title">Withdrawal Plan</div>
            <div class="input-group"><div class="label-row"><span>Corpus</span></div><input type="number" class="input-field" id="swp_amount_num" value="1000000" oninput="sync('swp_amount', 'num')"><input type="range" id="swp_amount_rng" min="100000" max="50000000" step="50000" value="1000000" oninput="sync('swp_amount', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Withdrawal</span></div><input type="number" class="input-field" id="swp_withdraw_num" value="5000" oninput="sync('swp_withdraw', 'num')"><input type="range" id="swp_withdraw_rng" min="500" max="200000" step="500" value="5000" oninput="sync('swp_withdraw', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Return (%)</span></div><input type="number" class="input-field" id="swp_rate_num" value="8" oninput="sync('swp_rate', 'num')"><input type="range" id="swp_rate_rng" min="1" max="20" step="0.5" value="8" oninput="sync('swp_rate', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Years</span></div><input type="number" class="input-field" id="swp_years_num" value="10" oninput="sync('swp_years', 'num')"><input type="range" id="swp_years_rng" min="1" max="40" step="1" value="10" oninput="sync('swp_years', 'rng')"></div>
        </div>
        <div class="panel">
            <div class="panel-title">Cash Flow</div>
            <div class="summary-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="stat-card"><span class="stat-label">Withdrawn</span><span class="stat-value text-green" id="swp_total_withdrawn">0</span></div>
                <div class="stat-card"><span class="stat-label">Final Bal</span><span class="stat-value text-gradient" id="swp_final_bal">0</span></div>
                <div class="stat-card"><span class="stat-label">Interest</span><span class="stat-value" id="swp_interest">0</span></div>
            </div>
            <div class="chart-container"><canvas id="swpChart"></canvas></div>
            <div class="table-scroll"><table id="swp_table"></table></div>
        </div>
    </div>

    <div id="lumpsum" class="calc-grid">
        <div class="panel">
            <div class="panel-title">Lumpsum</div>
            <div class="input-group"><div class="label-row"><span>Amount</span></div><input type="number" class="input-field" id="int_amount_num" value="100000" oninput="sync('int_amount', 'num')"><input type="range" id="int_amount_rng" min="5000" max="10000000" step="5000" value="100000" oninput="sync('int_amount', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Rate (%)</span></div><input type="number" class="input-field" id="int_rate_num" value="7" oninput="sync('int_rate', 'num')"><input type="range" id="int_rate_rng" min="1" max="15" step="0.1" value="7" oninput="sync('int_rate', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Years</span></div><input type="number" class="input-field" id="int_years_num" value="5" oninput="sync('int_years', 'num')"><input type="range" id="int_years_rng" min="1" max="25" step="1" value="5" oninput="sync('int_years', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Type</span></div><select id="int_type" class="custom-select" onchange="toggleFrequency(); recalcActive();"><option value="compound">Compound Interest</option><option value="simple">Simple Interest</option></select></div>
            <div class="input-group" id="freq_group"><div class="label-row"><span>Frequency</span></div><select id="int_freq" class="custom-select" onchange="recalcActive()"><option value="1">Yearly</option><option value="2">Half-Yearly</option><option value="4">Quarterly</option><option value="12">Monthly</option></select></div>
        </div>
        <div class="panel">
            <div class="panel-title">Maturity</div>
            <div class="summary-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="stat-card"><span class="stat-label">Maturity</span><span class="stat-value text-gradient" id="int_final">0</span></div>
                <div class="stat-card"><span class="stat-label">Principal</span><span class="stat-value" id="int_principal_disp">0</span></div>
                <div class="stat-card"><span class="stat-label">Interest</span><span class="stat-value text-green" id="int_gains_disp">0</span></div>
            </div>
            <div class="chart-container"><canvas id="intChart"></canvas></div>
            <div class="table-scroll"><table id="int_table"></table></div>
        </div>
    </div>

    <div id="trade" class="calc-grid">
        <div class="panel">
            <div class="panel-title">Trade Config</div>
            <div class="input-group"><div class="label-row"><span>Buy</span></div><input type="number" class="input-field" id="trade_buy" value="100" oninput="recalcActive()"></div>
            <div class="input-group"><div class="label-row"><span>Sell</span></div><input type="number" class="input-field" id="trade_sell" value="115" oninput="recalcActive()"></div>
            <div class="input-group"><div class="label-row"><span>Qty</span></div><input type="number" class="input-field" id="trade_qty" value="50" oninput="recalcActive()"></div>
        </div>
        <div class="panel">
            <div class="panel-title">P&L Report</div>
            <div class="summary-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="stat-card"><span class="stat-label">Net P&L</span><span class="stat-value" id="trade_pnl">0</span></div>
                <div class="stat-card"><span class="stat-label">Turnover</span><span class="stat-value" id="trade_turnover">0</span></div>
                <div class="stat-card"><span class="stat-label">ROI</span><span class="stat-value" id="trade_roi">0%</span></div>
            </div>
            <div class="chart-container"><canvas id="tradeChart"></canvas></div>
        </div>
    </div>

</div>

<script>
    /* --- CONFIG & STATE --- */
    let customPayments = { re: [], loan: [] };
    let strategies = { re: 'tenure', loan: 'tenure' }; 
    let charts = { sip: null, loan: null, swp: null, re: null, int: null, trade: null, smart: null };
    const formatMoney = (num) => num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

    /* --- SAFE GET/SET --- */
    function safeSet(id, val) {
        const el = document.getElementById(id);
        if (el) {
            if (el.tagName === 'INPUT' || el.tagName === 'SELECT') el.value = val;
            else el.innerText = val;
        }
    }
    function safeGet(id) {
        const el = document.getElementById(id);
        return el ? (parseFloat(el.value) || 0) : 0;
    }

    /* --- INIT --- */
    window.onload = function() {
        calculateSmartPlan('base'); 
    }

    /* --- THEME --- */
    function toggleTheme() {
        const h=document.documentElement; const c=h.getAttribute('data-theme'); const n=c==='dark'?'light':'dark';
        h.setAttribute('data-theme', n); localStorage.setItem('theme', n);
        recalcActive();
    }
    (function initTheme(){ const s=localStorage.getItem('theme')||'light'; document.documentElement.setAttribute('data-theme', s); })();

    /* --- NAV --- */
    function switchTab(id) {
        document.querySelectorAll('.calc-grid').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const btns=document.querySelectorAll('.tab-btn');
        if(id=='smartplan')btns[0].classList.add('active');
        if(id=='realestate')btns[1].classList.add('active');
        if(id=='loan')btns[2].classList.add('active');
        if(id=='sip')btns[3].classList.add('active');
        if(id=='swp')btns[4].classList.add('active');
        if(id=='lumpsum')btns[5].classList.add('active');
        if(id=='trade')btns[6].classList.add('active');
        recalcActive();
    }

    /* --- INPUT SYNC --- */
    function sync(idBase, source) {
        const num = document.getElementById(idBase + '_num'); const rng = document.getElementById(idBase + '_rng');
        if(num && rng) { if(source === 'rng') num.value = rng.value; else rng.value = num.value; }
        recalcActive();
    }
    function syncDP(source) {
        const sft = safeGet('re_sft'); const price = safeGet('re_price_sft'); const total = sft*price;
        if(total===0) return;
        const amtEl = document.getElementById('re_dp_amt');
        const rngEl = document.getElementById('re_dp_rng');
        const perEl = document.getElementById('re_dp_percent');
        const disp = document.getElementById('re_dp_percent_disp');

        if(source==='amt') {
            let p=(safeGet('re_dp_amt')/total)*100; if(p>100)p=100;
            if(perEl) perEl.value=p.toFixed(2); 
            if(rngEl) rngEl.value=p; 
            if(disp) disp.innerText=p.toFixed(0);
        } else {
            let p = source==='rng' ? (rngEl?rngEl.value:20) : (perEl?perEl.value:20);
            if(rngEl) rngEl.value=p; if(perEl) perEl.value=p; 
            if(disp) disp.innerText=parseFloat(p).toFixed(0);
            if(amtEl) amtEl.value=(total*(p/100)).toFixed(0);
        }
        calculateRealEstate();
    }
    function recalcActive() {
        if(document.getElementById('smartplan').classList.contains('active')) calculateSmartPlan('base');
        else if(document.getElementById('realestate').classList.contains('active')) calculateRealEstate();
        else if(document.getElementById('loan').classList.contains('active')) calculateLoan();
        else if(document.getElementById('sip').classList.contains('active')) calculateSIP();
        else if(document.getElementById('swp').classList.contains('active')) calculateSWP();
        else if(document.getElementById('lumpsum').classList.contains('active')) calculateInterest();
        else if(document.getElementById('trade').classList.contains('active')) calculateTrade();
    }

    /* --- PAYMENTS & STRATEGY --- */
    function setStrategy(type, strat) {
        strategies[type] = strat;
        const btnTenure = document.getElementById(type+'_strat_tenure');
        const btnEmi = document.getElementById(type+'_strat_emi');
        if(btnTenure) btnTenure.classList.toggle('selected', strat==='tenure');
        if(btnEmi) btnEmi.classList.toggle('selected', strat==='emi');
        recalcActive();
    }
    function addPayment(type) {
        const a=safeGet(type+'_part_amt'); const y=parseInt(document.getElementById(type+'_part_year').value)||0;
        if(!a||!y) return alert("Invalid amount/year");
        customPayments[type].push({amt:a, year:y});
        safeSet(type+'_part_amt',''); safeSet(type+'_part_year','');
        renderPayments(type); recalcActive();
    }
    function removePayment(type, i) { customPayments[type].splice(i,1); renderPayments(type); recalcActive(); }
    function renderPayments(type) {
        const c=document.getElementById(type+'_payments_list'); 
        if(!c) return;
        c.innerHTML='';
        customPayments[type].sort((a,b)=>a.year-b.year).forEach((p,i)=>{
            c.innerHTML+=`<div class="tag"><span>Yr ${p.year}: ${formatMoney(p.amt)}</span><span class="tag-close" onclick="removePayment('${type}',${i})">‚úï</span></div>`;
        });
    }
    function getPrepay(type, yr) { return customPayments[type].filter(p=>p.year===yr).reduce((s,p)=>s+p.amt,0); }

    /* --- CHART --- */
    function updateChart(id, cvs, lbls, d1, l1, c1, d2, l2, c2, d3, l3, c3) {
        const el = document.getElementById(cvs);
        if(!el) return;
        const ctx=el.getContext('2d');
        if(charts[id]) charts[id].destroy();
        const isDark=document.documentElement.getAttribute('data-theme')==='dark';
        const txt=isDark?'#94A3B8':'#6B7280'; const grd=isDark?'#334155':'#E5E7EB';
        
        let ds = [];
        let grad1=ctx.createLinearGradient(0,0,0,400); grad1.addColorStop(0,c1); grad1.addColorStop(1,c1+'00');
        ds.push({label:l1, data:d1, borderColor:c1, backgroundColor:grad1, tension:0.4, fill:true, borderWidth:2, pointRadius:0});
        
        if(d2) ds.push({label:l2, data:d2, borderColor:c2, backgroundColor:c2+'10', tension:0.4, fill:true, borderWidth:2, pointRadius:0, borderDash:[5,5]});
        if(d3) ds.push({label:l3, data:d3, borderColor:c3, backgroundColor:c3+'10', tension:0.4, fill:true, borderWidth:2, pointRadius:0});

        charts[id]=new Chart(ctx,{type:'line', data:{labels:lbls, datasets:ds}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:txt,font:{family:'Plus Jakarta Sans'}}}, tooltip:{mode:'index', intersect:false}}, scales:{x:{ticks:{color:txt}, grid:{color:grd, drawBorder:false}}, y:{ticks:{color:txt, callback:v=>v>=1000?v/1000+'k':v}, grid:{color:grd, drawBorder:false}}}}});
    }

    /* --- TABLE --- */
    function renderTable(id, h, r) {
        const el = document.getElementById(id); if(!el) return;
        let ht=`<thead><tr>`; h.forEach(x=>ht+=`<th>${x}</th>`); ht+=`</tr></thead><tbody>`;
        r.forEach(x=>{
            let cls=x.pre?'class="hl-row"':'';
            ht+=`<tr ${cls}>`; x.d.forEach((c,i)=>{ let v=c; if(i===2&&x.pre) v+=`<div style="font-size:0.75rem; color:var(--success); font-weight:700">+${formatMoney(x.preVal)}</div>`; ht+=`<td>${v}</td>`; }); ht+=`</tr>`;
        });
        el.innerHTML=ht+`</tbody>`;
    }

    /* --- 0. SMART PLAN LOGIC (BIDIRECTIONAL) --- */
    function calculateSmartPlan(source) {
        if(source.includes('amount')) {
            const num = document.getElementById('smart_plan_amount_num');
            const rng = document.getElementById('smart_plan_amount_rng');
            if(source === 'amount_rng') num.value = rng.value; else rng.value = num.value;
        }
        if(source.includes('rate')) {
            const num = document.getElementById('smart_plan_rate_num');
            const rng = document.getElementById('smart_plan_rate_rng');
            if(source === 'rate_rng') num.value = rng.value; else rng.value = num.value;
        }

        const monthly = safeGet('smart_amt_num');
        const invYears = safeGet('smart_inv_yrs_num');
        const waitYears = safeGet('smart_wait_yrs_num');
        const rateMF = safeGet('smart_mf_rate_num');
        
        safeSet('smart_total_dur', invYears + waitYears);
        const monthsInv = invYears * 12;
        const monthsWait = waitYears * 12;

        let ratePlan = safeGet('smart_plan_rate_num');
        let targetPlanAmount = safeGet('smart_plan_amount_num');

        if (source.includes('amount') && targetPlanAmount > 0) {
            ratePlan = findRate(monthly, monthsInv, monthsWait, targetPlanAmount);
            safeSet('smart_plan_rate_num', ratePlan.toFixed(2));
            document.getElementById('smart_plan_rate_rng').value = ratePlan.toFixed(2);
        } else {
            targetPlanAmount = calculateCorpus(monthly, monthsInv, monthsWait, ratePlan);
            safeSet('smart_plan_amount_num', targetPlanAmount.toFixed(0));
            document.getElementById('smart_plan_amount_rng').value = targetPlanAmount;
        }

        let corpusMF = calculateCorpus(monthly, monthsInv, monthsWait, rateMF);
        let totalInv = monthly * monthsInv;

        safeSet('smart_invested', formatMoney(totalInv));
        safeSet('smart_plan_val', formatMoney(targetPlanAmount));
        safeSet('smart_mf_val', formatMoney(corpusMF));
        safeSet('smart_gap', formatMoney(corpusMF - targetPlanAmount));

        generateSmartChart(monthly, monthsInv, monthsWait, ratePlan, rateMF);
    }

    function calculateCorpus(monthly, invMonths, waitMonths, rate) {
        let corpus = 0;
        let r = rate/1200;
        for(let m=1; m<=invMonths; m++) corpus = (corpus + monthly) * (1 + r);
        for(let m=1; m<=waitMonths; m++) corpus = corpus * (1 + r);
        return corpus;
    }

    function findRate(monthly, invMonths, waitMonths, targetVal) {
        let low = 0, high = 100;
        for(let i=0; i<50; i++) {
            let mid = (low+high)/2;
            let val = calculateCorpus(monthly, invMonths, waitMonths, mid);
            if(val > targetVal) high = mid;
            else low = mid;
        }
        return low;
    }

    function generateSmartChart(monthly, invMonths, waitMonths, rPlan, rMF) {
        let labels = ['Start'];
        let dInv = [0];
        let dPlan = [0];
        let dMF = [0];
        let cPlan = 0, cMF = 0, totInv = 0;

        for(let m=1; m<=invMonths; m++) {
            cPlan = (cPlan + monthly) * (1 + rPlan/1200);
            cMF = (cMF + monthly) * (1 + rMF/1200);
            totInv += monthly;
            if(m%12===0) {
                labels.push('Yr '+m/12);
                dInv.push(totInv); dPlan.push(cPlan); dMF.push(cMF);
            }
        }
        for(let m=1; m<=waitMonths; m++) {
            cPlan = cPlan * (1 + rPlan/1200);
            cMF = cMF * (1 + rMF/1200);
            if(m%12===0) {
                labels.push('Yr '+(invMonths/12 + m/12));
                dInv.push(totInv); dPlan.push(cPlan); dMF.push(cMF);
            }
        }
        updateChart('smart', 'smartChart', labels, dInv, 'Invested', '#9CA3AF', dPlan, 'Traditional Plan', '#6366F1', dMF, 'Mutual Fund', '#10B981');
    }

    /* --- SCHEDULE ENGINE --- */
    function genSchedule(P, emi, r, yrs, type, cost, tid, cid, origTotal, rentalYield) {
        let bal=P; let paid=0; let mElapsed=0; let closed=false; let currentEMI = emi;
        let lbls=['Start']; let dBal=[P]; let dVal=[cost]; let cVal=cost;
        let dWealth = [cost]; 
        let accumRent = 0;
        let rows=[]; let schedule=[];
        let strategy = strategies[type]; 

        for(let y=1; y<=yrs; y++){
            let pre=getPrepay(type, y);
            for(let m=1; m<=12; m++){
                if(bal<=0) { closed=true; break; }
                let int=bal*r; let prin=currentEMI-int; 
                if(bal<prin) { prin=bal; int=0; closed=true; }
                bal-=prin; paid+=currentEMI; mElapsed++;
                
                let row={m:(y-1)*12+m, i:int, p:prin, b:bal, pre:0};
                if(m===12 && pre>0 && !closed){
                    if(bal<pre) pre=bal;
                    bal-=pre; paid+=pre; row.pre=pre; row.b=bal;
                    if(bal<=0) closed=true;
                    if(strategy === 'emi' && !closed) {
                        let remMonths = (yrs*12) - mElapsed;
                        if(remMonths > 0) currentEMI = (bal * r * Math.pow(1+r, remMonths)) / (Math.pow(1+r, remMonths) - 1);
                    }
                }
                schedule.push(row);
                if(closed) break;
            }
            lbls.push('Yr '+y); dBal.push(bal<0?0:bal); 
            if(type==='re'){ 
                cVal*=1.05; dVal.push(cVal); 
                let yearlyRent = cVal * (rentalYield/100);
                accumRent += yearlyRent;
                dWealth.push(cVal + (accumRent * 2));
            }
        }

        let allInt = schedule.reduce((s,x)=>s+x.i,0); let run=0;
        schedule.forEach(x=>{
            let rem = allInt-run-x.i; run+=x.i;
            rows.push({ d:[x.m, formatMoney(x.i), formatMoney(x.p+x.pre), formatMoney(x.b), formatMoney(rem>0?rem:0)], pre:x.pre>0, preVal:x.pre });
        });

        renderTable(tid, ['Month','Interest','Paid','Balance','Int. Rem'], rows);
        let saved = origTotal-paid; let timeSave = (yrs*12-mElapsed)/12;
        safeSet(type+'_saved', saved>0?formatMoney(saved):"0");
        safeSet(type+'_time_saved', timeSave>0?timeSave.toFixed(1)+" Yrs":"0 Yrs");
        if(type==='loan') safeSet('loan_total_pay', formatMoney(paid));
        
        if(type==='re') {
            safeSet('re_rent_val', formatMoney(cVal + (accumRent * 2)));
            updateChart(type, cid, lbls, dWealth, 'Wealth (Prop + 2x Rent)', '#10B981', dBal, 'Loan', '#EF4444', dVal, 'Prop Value', '#8B5CF6');
        } else updateChart(type, cid, lbls, dBal, 'Balance', '#6366F1');
    }

    /* --- CALCULATORS --- */
    function calculateRealEstate(src) {
        const sft = safeGet('re_sft'); const price = safeGet('re_price_sft'); const cost = sft*price;
        if(src==='cost') { 
            let p = safeGet('re_dp_percent') || 20; 
            safeSet('re_dp_amt', (cost*(p/100)).toFixed(0)); 
        }
        if(safeGet('re_dp_amt') === 0 && cost > 0) safeSet('re_dp_amt', (cost*0.2).toFixed(0));
        
        const dp = safeGet('re_dp_amt'); const loan = cost-dp;
        const rate = safeGet('re_rate_num'); const r = rate/1200; const n = 20*12; 
        const yieldPercent = safeGet('re_yield_num');
        
        let emi = 0; if(r>0) emi=loan*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1);

        safeSet('re_total_cost', formatMoney(cost));
        safeSet('re_loan_amt', formatMoney(loan));
        safeSet('re_emi_input', formatMoney(emi));
        safeSet('re_emi', formatMoney(emi));
        
        genSchedule(loan, emi, r, 20, 're', cost, 're_table', 'reChart', emi*n, yieldPercent);
    }

    function calculateLoan() {
        const loan=safeGet('loan_amount_num'); const rate=safeGet('loan_rate_num'); const yrs=safeGet('loan_years_num');
        const r=rate/1200; const n=yrs*12;
        let emi=0; if(r>0&&n>0) emi=loan*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1);
        
        safeSet('loan_emi_input', formatMoney(emi));
        safeSet('loan_emi', formatMoney(emi));
        
        genSchedule(loan, emi, r, yrs, 'loan', 0, 'loan_table', 'loanChart', emi*n, 0);
    }

    function calculateSIP(){
        const monthly = safeGet('sip_amount_num'); const rate = safeGet('sip_rate_num'); const years = safeGet('sip_years_num');
        const isStepUp = document.getElementById('sip_stepup_check').checked;
        const stepVal = safeGet('sip_step_val');
        const stepType = document.querySelector('input[name="stepup_type"]:checked').value;

        let totalInv = 0; let currentVal = 0; let currentMonthly = monthly;
        const monthlyRate = rate / 100 / 12; const months = years * 12;
        let labels = []; let valData = []; let invData = []; let rows = [];

        for (let m = 1; m <= months; m++) {
            currentVal = (currentVal + currentMonthly) * (1 + monthlyRate);
            totalInv += currentMonthly;
            if (isStepUp && m % 12 === 0 && m < months) {
                if (stepType === 'percent') currentMonthly = currentMonthly * (1 + stepVal / 100);
                else currentMonthly = currentMonthly + stepVal;
            }
            if (m % 12 === 0) {
                let yr = m/12; labels.push('Yr ' + yr); valData.push(currentVal); invData.push(totalInv);
                rows.push({d:['Year ' + yr, formatMoney(totalInv), formatMoney(currentVal)]});
            }
        }
        safeSet('sip_total', formatMoney(currentVal));
        safeSet('sip_invested', formatMoney(totalInv));
        safeSet('sip_gains', formatMoney(currentVal - totalInv));
        
        updateChart('sip', 'sipChart', labels, valData, 'Value', '#6366F1', invData, 'Invested', '#9CA3AF');
        renderTable('sip_table', ['Year', 'Invested', 'Value'], rows);
    }

    function calculateSWP() {
        const corpus = safeGet('swp_amount_num'); const withdrawal = safeGet('swp_withdraw_num');
        const rate = safeGet('swp_rate_num'); const years = safeGet('swp_years_num');
        
        let balance = corpus; let totalWithdrawn = 0; let totalInterest = 0;
        const monthlyRate = rate / 100 / 12; const months = years * 12;
        
        let labels = ['Start']; let balData = [corpus]; let withdrawData = [0]; let rows = [];

        for(let m = 1; m <= months; m++) {
            let interest = balance * monthlyRate; totalInterest += interest; balance += interest;
            let actWithdraw = withdrawal;
            if(balance < withdrawal) { actWithdraw = balance; balance = 0; } else { balance -= withdrawal; }
            totalWithdrawn += actWithdraw;
            if(m % 12 === 0) {
                let yr = m/12; labels.push('Yr ' + yr); balData.push(balance); withdrawData.push(totalWithdrawn);
                rows.push({d:['Year '+yr, formatMoney(totalWithdrawn), formatMoney(balance)]});
            }
            if(balance <= 0) break;
        }
        safeSet('swp_total_withdrawn', formatMoney(totalWithdrawn));
        safeSet('swp_final_bal', formatMoney(balance));
        safeSet('swp_interest', formatMoney(totalInterest));
        updateChart('swp', 'swpChart', labels, balData, 'Balance', '#6366F1', withdrawData, 'Withdrawn', '#10B981');
        renderTable('swp_table', ['Year', 'Withdrawn', 'Balance'], rows);
    }

    function calculateInterest(){
        const p=safeGet('int_amount_num'); const r=safeGet('int_rate_num'); const y=safeGet('int_years_num');
        const typ=document.getElementById('int_type').value; const fr=parseFloat(document.getElementById('int_freq').value)||1;
        let lbls=[], dVal=[], rows=[];
        for(let i=1; i<=y; i++){
            let v = typ==='simple' ? p+(p*r*i/100) : p*Math.pow(1+(r/(100*fr)), fr*i);
            lbls.push('Yr '+i); dVal.push(v); rows.push({d:['Yr '+i, formatMoney(p), formatMoney(v)]});
        }
        let f=dVal[dVal.length-1]||0;
        safeSet('int_final', formatMoney(f)); safeSet('int_principal_disp', formatMoney(p)); safeSet('int_gains_disp', formatMoney(f-p));
        updateChart('int', 'intChart', lbls, dVal, 'Maturity', '#10B981'); renderTable('int_table', ['Year','Principal','Value'], rows);
    }

    function toggleFrequency() { document.getElementById('freq_group').style.display = document.getElementById('int_type').value === 'compound' ? 'block' : 'none'; recalcActive(); }
    function toggleStepUp() { document.getElementById('stepup_panel').style.display = document.getElementById('sip_stepup_check').checked ? 'block' : 'none'; calculateSIP(); }
    
    function calculateTrade(){
        const b=safeGet('trade_buy'); const s=safeGet('trade_sell'); const q=safeGet('trade_qty');
        const p=(s-b)*q; safeSet('trade_pnl', formatMoney(p)); safeSet('trade_turnover', formatMoney((b+s)*q)); safeSet('trade_roi', (b>0?p/(b*q)*100:0).toFixed(2)+'%');
        let l=[], d=[], st=s*0.05, start=s*0.75;
        for(let i=0; i<=10; i++){ let pr=start+(st*i); l.push(pr.toFixed(1)); d.push((pr-b)*q); }
        updateChart('trade', 'tradeChart', l, d, 'P&L', '#6366F1');
    }
</script>
</body>
</html>
