<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Financial Calculator V8.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366F1; --primary-dark: #4F46E5; --primary-light: #EEF2FF;
            --secondary: #10B981; --accent: #F59E0B; --danger: #EF4444;
            --bg-app: #F8FAFC; --bg-card: #FFFFFF; --bg-input: #F1F5F9;
            --text-main: #0F172A; --text-muted: #64748B; --border: #E2E8F0;
            --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --slider-track: #CBD5E1;
            
            --trad-bg: #EEF2FF; --trad-border: #6366F1;
            --mf-bg: #ECFDF5; --mf-border: #10B981;
        }
        [data-theme="dark"] {
            --bg-app: #0F172A; --bg-card: #1E293B; --bg-input: #0F172A;
            --text-main: #F8FAFC; --text-muted: #94A3B8; --border: #334155;
            --primary-light: #2E1065; --slider-track: #334155;
            
            --trad-bg: #1E1B4B; --trad-border: #6366F1;
            --mf-bg: #064E3B; --mf-border: #10B981;
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-app); color: var(--text-main); margin: 0; padding: 15px; transition: 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; padding-bottom: 50px; }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 15px 20px; background: var(--bg-card); border-radius: 20px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); }
        h1 { font-size: 1.4rem; font-weight: 800; margin: 0; background: linear-gradient(135deg, var(--primary), #A855F7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .theme-btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 8px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 0.9rem; }

        /* TABS */
        .tabs-container { display: flex; gap: 8px; margin-bottom: 25px; overflow-x: auto; padding: 4px; background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border); scrollbar-width: none; }
        .tabs-container::-webkit-scrollbar { display: none; }
        .tab-btn { flex: 0 0 auto; padding: 10px 18px; border: none; background: transparent; color: var(--text-muted); font-weight: 700; border-radius: 12px; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }

        /* LAYOUT */
        .calc-grid { display: none; grid-template-columns: 380px 1fr; gap: 25px; align-items: start; animation: fadeIn 0.3s ease-out; }
        .calc-grid.active { display: grid; }
        @media (max-width: 1024px) { .calc-grid.active { grid-template-columns: 1fr; } }

        /* PANELS */
        .panel { background: var(--bg-card); border-radius: 24px; padding: 25px; box-shadow: var(--shadow-md); border: 1px solid var(--border); position: relative; }
        .panel-title { font-size: 1rem; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.5px; }

        /* CONTROLS (Steppers Fixed) */
        .input-group { margin-bottom: 20px; }
        .label-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem; font-weight: 700; color: var(--text-muted); }
        .row-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .stepper-wrapper {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-input); border: 1px solid var(--border); border-radius: 14px;
            padding: 2px; transition: 0.2s; width: 100%;
        }
        .stepper-wrapper:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

        .step-btn {
            width: 36px; height: 36px; flex-shrink: 0; border: none; background: var(--bg-card); 
            border-radius: 10px; color: var(--text-main); font-size: 1.2rem; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-sm); transition: 0.1s; user-select: none;
        }
        .step-btn:active { transform: scale(0.92); background: var(--border); }
        
        .input-field {
            width: 100%; min-width: 0; border: none; background: transparent; text-align: center;
            font-size: 1rem; font-weight: 700; color: var(--text-main); padding: 0 4px; 
            font-family: 'Plus Jakarta Sans', sans-serif; -moz-appearance: textfield;
        }
        .input-field::-webkit-inner-spin-button { -webkit-appearance: none; }
        .readonly { background: var(--primary-light); color: var(--primary); border:none; text-align:center; padding:12px; border-radius:12px; font-weight:800; font-size:1.2rem; width:100%; display:block; }

        /* DROPDOWNS & PILLS */
        .pill-select-wrapper { position: relative; display: inline-block; width: 100%; }
        .pill-select, .custom-select { 
            appearance: none; -webkit-appearance: none; width: 100%;
            background: var(--bg-input); border: 1px solid var(--border);
            color: var(--text-main); font-weight: 700; padding: 12px 16px; border-radius: 12px;
            font-size: 0.95rem; cursor: pointer; font-family: inherit; text-align: center;
        }
        .header-pill { background: var(--primary-light); color: var(--primary); padding: 6px 30px 6px 14px; border-radius: 20px; font-size: 0.8rem; border: 1px solid var(--primary); width: auto; }

        /* SLIDERS */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; margin-top: 10px; display: block; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: var(--slider-track); border-radius: 10px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: var(--bg-card); border: 2px solid var(--primary); margin-top: -7px; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }

        /* STRATEGY TOGGLE */
        .strategy-toggle { display: flex; background: var(--bg-input); padding: 4px; border-radius: 14px; border: 1px solid var(--border); margin-bottom: 20px; }
        .strategy-opt { flex: 1; text-align: center; padding: 10px; font-size: 0.85rem; font-weight: 700; cursor: pointer; border-radius: 10px; color: var(--text-muted); transition: 0.2s; }
        .strategy-opt.selected { background: var(--primary); color: #ffffff; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.4); }

        /* EXTRAS */
        .trad-box { background: var(--trad-bg); border: 1px solid var(--trad-border); padding: 15px; border-radius: 16px; margin-top: 20px; }
        .mf-box { background: var(--mf-bg); border: 1px solid var(--mf-border); padding: 15px; border-radius: 16px; margin-top: 20px; }
        .extra-pay-box { background: linear-gradient(145deg, var(--bg-input), var(--bg-card)); border: 1px dashed var(--border); padding: 20px; border-radius: 16px; margin-top: 30px; }
        .btn-add { width: 100%; padding: 14px; background: var(--text-main); color: var(--bg-card); border: none; border-radius: 14px; font-weight: 700; cursor: pointer; margin-top: 15px; font-size: 0.95rem; }
        .tag { display: flex; justify-content: space-between; background: var(--bg-card); border: 1px solid var(--border); padding: 10px 14px; border-radius: 8px; margin-top: 10px; font-size: 0.85rem; font-weight: 600; align-items: center; }
        .tag-close { color: var(--danger); cursor: pointer; font-weight: 800; padding: 4px; }
        
        /* SUB-SECTION BOX */
        .sub-config {
            border: 1px solid var(--border); background: var(--bg-input);
            padding: 15px; border-radius: 16px; margin-bottom: 20px;
        }

        /* RESULTS & CHART SPACING */
        .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px; } 
        .stat-card { background: var(--bg-input); border-radius: 16px; padding: 16px; text-align: center; border: 1px solid transparent; }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin-bottom: 8px; letter-spacing: 0.5px; }
        .stat-value { font-size: 1.2rem; font-weight: 800; color: var(--text-main); word-break: break-all; line-height: 1.3; }
        
        .chart-container { position: relative; height: 320px; width: 100%; margin-top: 25px; padding-top: 10px; }
        
        .table-scroll { max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 16px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 400px; }
        th { background: var(--bg-input); padding: 14px; text-align: right; font-weight: 700; color: var(--text-muted); position: sticky; top: 0; z-index: 2; border-bottom: 1px solid var(--border); white-space: nowrap; }
        td { padding: 12px 14px; text-align: right; border-bottom: 1px solid var(--border); font-variant-numeric: tabular-nums; }
        th:first-child, td:first-child { text-align: left; }
        .hl-row { background: rgba(16, 185, 129, 0.1); }
        .text-green { color: var(--secondary); } .text-purple { color: #6366F1; } .text-orange { color: var(--accent); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Grid Fixes */
        @media (max-width: 600px) { .row-grid { grid-template-columns: 1fr; gap: 10px; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="brand"><h1>Financial Calculator</h1></div>
        <button class="theme-btn" onclick="toggleTheme()">‚òÄ / üåô</button>
    </header>

    <div class="tabs-container">
        <button class="tab-btn active" id="btn_realestate" onclick="switchTab('realestate')">Real Estate</button>
        <button class="tab-btn" id="btn_smartplan" onclick="switchTab('smartplan')">Smart Plan</button>
        <button class="tab-btn" id="btn_loan" onclick="switchTab('loan')">Home Loan</button>
        <button class="tab-btn" id="btn_sip" onclick="switchTab('sip')">SIP</button>
        <button class="tab-btn" id="btn_swp" onclick="switchTab('swp')">SWP</button>
        <button class="tab-btn" id="btn_lumpsum" onclick="switchTab('lumpsum')">Lumpsum</button>
        <button class="tab-btn" id="btn_trade" onclick="switchTab('trade')">Trade</button>
    </div>

    <div id="realestate" class="calc-grid active">
        <div class="panel">
            <div class="panel-title">
                Property Config
                <div class="pill-select-wrapper" style="width:auto"><select id="re_unit_type" class="pill-select header-pill" onchange="updateReLabels()"><option value="sft">Sq.Ft</option><option value="syd">Sq.Yd</option><option value="sm">Sq.M</option><option value="acre">Acre</option></select></div>
            </div>
            
            <div class="input-group">
                <div class="label-row"><span id="re_area_lbl">Area</span><span id="re_price_lbl">Base Price/Unit</span></div>
                <div class="row-grid">
                    <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('re_sft', -50)">-</button><input type="number" class="input-field" id="re_sft" value="1500" oninput="calculateRealEstate('cost')"><button class="step-btn" onclick="stepVal('re_sft', 50)">+</button></div>
                    <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('re_price_sft', -100)">-</button><input type="number" class="input-field" id="re_price_sft" value="6500" oninput="calculateRealEstate('cost')"><button class="step-btn" onclick="stepVal('re_price_sft', 100)">+</button></div>
                </div>
            </div>

            <div class="sub-config">
                <div class="panel-title" style="margin-bottom:0; cursor:pointer; font-size:0.9rem; color:var(--primary)" onclick="toggleAddCharges()">
                    <span>Additional Charges (Optional)</span>
                    <span id="add_charge_icon" style="font-size:1.2rem; font-weight:bold">+</span>
                </div>
                <div id="add_charges_content" style="display:none; padding-top:20px; border-top:1px dashed var(--border); margin-top:15px;">
                    <div class="input-group">
                        <div class="label-row"><span>Corner Cost (/Unit)</span><span>Facing Cost (/Unit)</span></div>
                        <div class="row-grid">
                            <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('re_cost_corner', -10)">-</button><input type="number" class="input-field" id="re_cost_corner" value="0" oninput="calculateRealEstate('cost')"><button class="step-btn" onclick="stepVal('re_cost_corner', 10)">+</button></div>
                            <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('re_cost_facing', -10)">-</button><input type="number" class="input-field" id="re_cost_facing" value="0" oninput="calculateRealEstate('cost')"><button class="step-btn" onclick="stepVal('re_cost_facing', 10)">+</button></div>
                        </div>
                    </div>

                    <div class="input-group">
                        <div class="label-row"><span>Floor Rise (/Unit)</span><span>Amenities (Fixed)</span></div>
                        <div class="row-grid">
                            <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('re_cost_floor', -10)">-</button><input type="number" class="input-field" id="re_cost_floor" value="0" oninput="calculateRealEstate('cost')"><button class="step-btn" onclick="stepVal('re_cost_floor', 10)">+</button></div>
                            <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('re_cost_amenities', -10000)">-</button><input type="number" class="input-field" id="re_cost_amenities" value="0" oninput="calculateRealEstate('cost')"><button class="step-btn" onclick="stepVal('re_cost_amenities', 10000)">+</button></div>
                        </div>
                    </div>

                    <div class="input-group" style="margin-bottom:0;">
                        <div class="label-row"><span>Corpus Fund (Fixed)</span></div>
                        <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('re_cost_corpus', -10000)">-</button><input type="number" class="input-field" id="re_cost_corpus" value="0" oninput="calculateRealEstate('cost')"><button class="step-btn" onclick="stepVal('re_cost_corpus', 10000)">+</button></div>
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <div class="label-row"><span>Down Payment Amount</span><span>Down Payment % (<span id="re_dp_percent_disp">20.00</span>)</span></div>
                <div style="display:grid; grid-template-columns: 1.2fr 1fr; gap:10px;">
                    <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('re_dp_amt', -50000)">-</button><input type="number" class="input-field" id="re_dp_amt" oninput="syncDP('amt')"><button class="step-btn" onclick="stepVal('re_dp_amt', 50000)">+</button></div>
                    <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('re_dp_percent', -0.25)">-</button><input type="number" class="input-field" id="re_dp_percent" value="20.00" step="0.01" oninput="syncDP('percent')"><button class="step-btn" onclick="stepVal('re_dp_percent', 0.25)">+</button></div>
                </div>
                <input type="range" id="re_dp_rng" min="0" max="99" step="0.1" value="20" oninput="syncDP('rng')">
            </div>

            <div class="input-group">
                <div class="label-row"><span>Loan Tenure (Years)</span></div>
                <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('re_tenure_num', -1)">-</button><input type="number" class="input-field" id="re_tenure_num" value="20" oninput="sync('re_tenure', 'num')"><button class="step-btn" onclick="stepVal('re_tenure_num', 1)">+</button></div>
                <input type="range" id="re_tenure_rng" min="1" max="40" step="1" value="20" oninput="sync('re_tenure', 'rng')">
            </div>

            <div class="input-group">
                <div class="label-row"><span>Interest Rate (%)</span></div>
                <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('re_rate_num', -0.25)">-</button><input type="number" class="input-field" id="re_rate_num" value="8.50" step="0.01" oninput="sync('re_rate', 'num')"><button class="step-btn" onclick="stepVal('re_rate_num', 0.25)">+</button></div>
                <input type="range" id="re_rate_rng" min="5" max="15" step="0.05" value="8.5" oninput="sync('re_rate', 'rng')">
            </div>

            <div class="input-group">
                <div class="label-row"><span>Rental Yield (%)</span></div>
                <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('re_yield_num', -0.25)">-</button><input type="number" class="input-field" id="re_yield_num" value="3.50" step="0.01" oninput="sync('re_yield', 'num')"><button class="step-btn" onclick="stepVal('re_yield_num', 0.25)">+</button></div>
                <input type="range" id="re_yield_rng" min="1" max="10" step="0.05" value="3.5" oninput="sync('re_yield', 'rng')">
            </div>
            
            <div class="input-group" style="margin-top:30px; border-top:1px dashed var(--border); padding-top:20px;">
                <div class="panel-title" style="font-size:0.9rem; margin-bottom:10px;">Pre-Closure Strategy</div>
                <div class="strategy-toggle"><div class="strategy-opt selected" id="re_strat_tenure" onclick="setStrategy('re', 'tenure')">Reduce Tenure</div><div class="strategy-opt" id="re_strat_emi" onclick="setStrategy('re', 'emi')">Reduce EMI</div></div>
                <div class="row-grid">
                    <div class="stepper-wrapper"><input type="number" id="re_part_amt" placeholder="Amount" class="input-field"></div>
                    <div class="stepper-wrapper"><input type="number" id="re_part_year" placeholder="Year" class="input-field"></div>
                </div>
                <button class="step-btn" style="width:100%; margin-top:10px; border-radius:12px; background:var(--text-main); color:var(--bg-card);" onclick="addPayment('re')">+ Add Payment</button>
                <div id="re_payments_list" style="margin-top:10px;"></div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">Valuation Analysis</div>
            <div class="summary-grid">
                <div class="stat-card"><span class="stat-label">Total Cost</span><span class="stat-value" id="re_total_cost">0</span></div>
                <div class="stat-card"><span class="stat-label">Initial EMI</span><span class="stat-value" id="re_emi">0</span></div>
                <div class="stat-card"><span class="stat-label">Prop + 2xRent</span><span class="stat-value text-green" id="re_rent_val">0</span></div>
                <div class="stat-card"><span class="stat-label">Interest Saved</span><span class="stat-value text-green" id="re_saved">0</span></div>
            </div>
            <div class="chart-container"><canvas id="reChart"></canvas></div>
            <div class="panel-title" style="margin-top:30px; font-size:0.9rem;">Monthly Schedule</div>
            <div class="table-scroll"><table id="re_table"></table></div>
        </div>
    </div>

    <div id="smartplan" class="calc-grid">
        <div class="panel">
            <div class="panel-title">Plan Config</div>
            <div class="strategy-toggle" style="margin-bottom: 20px;">
                <div class="strategy-opt selected" id="smart_freq_monthly" onclick="setSmartFreq('monthly')">Monthly</div>
                <div class="strategy-opt" id="smart_freq_yearly" onclick="setSmartFreq('yearly')">Yearly</div>
            </div>
            <div class="input-group">
                <div class="label-row"><span id="smart_amt_label">Monthly Investment</span></div>
                <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('smart_amt_num', -500)">-</button><input type="number" class="input-field" id="smart_amt_num" value="10000" oninput="sync('smart_amt', 'num')"><button class="step-btn" onclick="stepVal('smart_amt_num', 500)">+</button></div>
                <input type="range" id="smart_amt_rng" min="1000" max="200000" step="500" value="10000" oninput="sync('smart_amt', 'rng')">
            </div>
            <div class="input-group">
                <div class="label-row"><span>Investment Years</span></div>
                <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('smart_inv_yrs_num', -1)">-</button><input type="number" class="input-field" id="smart_inv_yrs_num" value="10" oninput="sync('smart_inv_yrs', 'num')"><button class="step-btn" onclick="stepVal('smart_inv_yrs_num', 1)">+</button></div>
                <input type="range" id="smart_inv_yrs_rng" min="1" max="40" step="1" value="10" oninput="sync('smart_inv_yrs', 'rng')">
            </div>
            <div class="input-group">
                <div class="label-row"><span>Wait Years</span></div>
                <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('smart_wait_yrs_num', -1)">-</button><input type="number" class="input-field" id="smart_wait_yrs_num" value="5" oninput="sync('smart_wait_yrs', 'num')"><button class="step-btn" onclick="stepVal('smart_wait_yrs_num', 1)">+</button></div>
                <input type="range" id="smart_wait_yrs_rng" min="0" max="30" step="1" value="5" oninput="sync('smart_wait_yrs', 'rng')">
                <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px; text-align:right;">Total: <span id="smart_total_dur">15</span> Yrs</div>
            </div>
            <div class="trad-box">
                <div class="label-row" style="color:var(--primary); font-weight:800;"><strong>üèõÔ∏è Traditional Plan</strong></div>
                <div class="input-group">
                    <div class="label-row"><span>Target Amount</span></div>
                    <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('smart_plan_amount_num', -50000)">-</button><input type="number" class="input-field" id="smart_plan_amount_num" placeholder="e.g. 25L" oninput="calculateSmartPlan('amount_num')"><button class="step-btn" onclick="stepVal('smart_plan_amount_num', 50000)">+</button></div>
                    <input type="range" id="smart_plan_amount_rng" min="100000" max="20000000" step="50000" value="2500000" oninput="calculateSmartPlan('amount_rng')">
                </div>
                <div class="input-group">
                    <div class="label-row"><span>Implied ROI (%)</span></div>
                    <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('smart_plan_rate_num', -0.1)">-</button><input type="number" class="input-field" id="smart_plan_rate_num" value="6.00" step="0.01" oninput="calculateSmartPlan('rate_num')"><button class="step-btn" onclick="stepVal('smart_plan_rate_num', 0.1)">+</button></div>
                </div>
            </div>
            <div class="mf-box">
                <div class="label-row" style="color:var(--success); font-weight:800;"><strong>üìà Mutual Fund</strong></div>
                <div class="input-group">
                    <div class="label-row"><span>Expected ROI (%)</span></div>
                    <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('smart_mf_rate_num', -0.5)">-</button><input type="number" class="input-field" id="smart_mf_rate_num" value="12.00" step="0.01" oninput="sync('smart_mf_rate', 'num')"><button class="step-btn" onclick="stepVal('smart_mf_rate_num', 0.5)">+</button></div>
                    <input type="range" id="smart_mf_rate_rng" min="5" max="25" step="0.5" value="12" oninput="sync('smart_mf_rate', 'rng')">
                </div>
            </div>
        </div>
        <div class="panel">
            <div class="panel-title">Smart Comparison</div>
            <div class="summary-grid">
                <div class="stat-card"><span class="stat-label">Invested</span><span class="stat-value" id="smart_invested">0</span></div>
                <div class="stat-card"><span class="stat-label">Traditional</span><span class="stat-value text-purple" id="smart_plan_val">0</span></div>
                <div class="stat-card"><span class="stat-label">Mutual Fund</span><span class="stat-value text-green" id="smart_mf_val">0</span></div>
                <div class="stat-card" style="border:1px solid var(--primary);"><span class="stat-label" style="color:var(--primary)">Wealth Gap</span><span class="stat-value" style="color:var(--primary)" id="smart_gap">0</span></div>
            </div>
            <div class="chart-container"><canvas id="smartChart"></canvas></div>
        </div>
    </div>

    <div id="loan" class="calc-grid">
        <div class="panel">
            <div class="panel-title">Loan Config</div>
            <div class="input-group"><div class="label-row"><span>Loan Amount</span></div><div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('loan_amount_num', -50000)">-</button><input type="number" class="input-field" id="loan_amount_num" value="5000000" oninput="sync('loan_amount', 'num')"><button class="step-btn" onclick="stepVal('loan_amount_num', 50000)">+</button></div><input type="range" id="loan_amount_rng" min="100000" max="20000000" step="50000" value="5000000" oninput="sync('loan_amount', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Rate (%)</span></div><div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('loan_rate_num', -0.25)">-</button><input type="number" class="input-field" id="loan_rate_num" value="8.50" step="0.01" oninput="sync('loan_rate', 'num')"><button class="step-btn" onclick="stepVal('loan_rate_num', 0.25)">+</button></div><input type="range" id="loan_rate_rng" min="5" max="20" step="0.1" value="8.5" oninput="sync('loan_rate', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Tenure (Years)</span></div><div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('loan_years_num', -1)">-</button><input type="number" class="input-field" id="loan_years_num" value="20" oninput="sync('loan_years', 'num')"><button class="step-btn" onclick="stepVal('loan_years_num', 1)">+</button></div><input type="range" id="loan_years_rng" min="1" max="30" step="1" value="20" oninput="sync('loan_years', 'rng')"></div>
            <div class="extra-pay-box">
                <div class="panel-title" style="font-size:0.9rem; margin-bottom:10px;">Pre-Payment Strategy</div>
                <div class="strategy-toggle"><div class="strategy-opt selected" id="loan_strat_tenure" onclick="setStrategy('loan', 'tenure')">Reduce Tenure</div><div class="strategy-opt" id="loan_strat_emi" onclick="setStrategy('loan', 'emi')">Reduce EMI</div></div>
                <div class="row-grid">
                    <div class="stepper-wrapper"><input type="number" id="loan_part_amt" placeholder="Amount" class="input-field"></div>
                    <div class="stepper-wrapper"><input type="number" id="loan_part_year" placeholder="Year" class="input-field"></div>
                </div>
                <button class="step-btn" style="width:100%; margin-top:10px; border-radius:12px; background:var(--text-main); color:var(--bg-card);" onclick="addPayment('loan')">+ Add Payment</button>
                <div id="loan_payments_list" style="margin-top:10px;"></div>
            </div>
        </div>
        <div class="panel">
            <div class="panel-title">Repayment</div>
            <div class="summary-grid">
                <div class="stat-card"><span class="stat-label">Initial EMI</span><span class="stat-value text-gradient" id="loan_emi">0</span></div>
                <div class="stat-card"><span class="stat-label">Total Paid</span><span class="stat-value" id="loan_total_pay">0</span></div>
                <div class="stat-card"><span class="stat-label">Saved</span><span class="stat-value text-green" id="loan_saved">0</span></div>
                <div class="stat-card"><span class="stat-label">Time Saved</span><span class="stat-value text-green" id="loan_time_saved">0 Yrs</span></div>
            </div>
            <div class="chart-container"><canvas id="loanChart"></canvas></div>
            <div class="table-scroll"><table id="loan_table"></table></div>
        </div>
    </div>

    <div id="sip" class="calc-grid">
        <div class="panel">
            <div class="panel-title">SIP Config</div>
            <div class="input-group"><div class="label-row"><span>Monthly Inv</span></div><div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('sip_amount_num', -500)">-</button><input type="number" class="input-field" id="sip_amount_num" value="5000" oninput="sync('sip_amount', 'num')"><button class="step-btn" onclick="stepVal('sip_amount_num', 500)">+</button></div><input type="range" id="sip_amount_rng" min="500" max="1000000" step="500" value="5000" oninput="sync('sip_amount', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Return (%)</span></div><div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('sip_rate_num', -0.25)">-</button><input type="number" class="input-field" id="sip_rate_num" value="12.00" step="0.01" oninput="sync('sip_rate', 'num')"><button class="step-btn" onclick="stepVal('sip_rate_num', 0.25)">+</button></div><input type="range" id="sip_rate_rng" min="1" max="30" step="0.5" value="12" oninput="sync('sip_rate', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Years</span></div><div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('sip_years_num', -1)">-</button><input type="number" class="input-field" id="sip_years_num" value="10" oninput="sync('sip_years', 'num')"><button class="step-btn" onclick="stepVal('sip_years_num', 1)">+</button></div><input type="range" id="sip_years_rng" min="1" max="40" step="1" value="10" oninput="sync('sip_years', 'rng')"></div>
            <div class="extra-pay-box">
                <label style="display:flex; align-items:center; margin-bottom:10px; font-weight:700;"><input type="checkbox" id="sip_stepup_check" onchange="toggleStepUp()" style="margin-right:10px;"> Enable Step-Up</label>
                <div id="stepup_panel" style="display:none;">
                    <div class="strategy-toggle">
                        <div class="strategy-opt selected" id="step_type_percent" onclick="setStepType('percent')">Percentage</div>
                        <div class="strategy-opt" id="step_type_value" onclick="setStepType('value')">Amount</div>
                    </div>
                    <input type="hidden" id="sip_step_type" value="percent">
                    <div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('sip_step_val', -1)">-</button><input type="number" class="input-field" id="sip_step_val" value="10" oninput="calculateSIP()"><button class="step-btn" onclick="stepVal('sip_step_val', 1)">+</button></div>
                </div>
            </div>
        </div>
        <div class="panel">
            <div class="panel-title">Growth</div>
            <div class="summary-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="stat-card"><span class="stat-label">Value</span><span class="stat-value text-purple" id="sip_total">0</span></div>
                <div class="stat-card"><span class="stat-label">Invested</span><span class="stat-value" id="sip_invested">0</span></div>
                <div class="stat-card"><span class="stat-label">Gains</span><span class="stat-value text-green" id="sip_gains">0</span></div>
            </div>
            <div class="chart-container"><canvas id="sipChart"></canvas></div>
            <div class="table-scroll"><table id="sip_table"></table></div>
        </div>
    </div>

    <div id="swp" class="calc-grid">
        <div class="panel">
            <div class="panel-title">SWP Config</div>
            <div class="input-group"><div class="label-row"><span>Corpus</span></div><div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('swp_amount_num', -50000)">-</button><input type="number" class="input-field" id="swp_amount_num" value="1000000" oninput="sync('swp_amount', 'num')"><button class="step-btn" onclick="stepVal('swp_amount_num', 50000)">+</button></div><input type="range" id="swp_amount_rng" min="100000" max="50000000" step="50000" value="1000000" oninput="sync('swp_amount', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Withdrawal</span></div><div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('swp_withdraw_num', -500)">-</button><input type="number" class="input-field" id="swp_withdraw_num" value="5000" oninput="sync('swp_withdraw', 'num')"><button class="step-btn" onclick="stepVal('swp_withdraw_num', 500)">+</button></div><input type="range" id="swp_withdraw_rng" min="500" max="200000" step="500" value="5000" oninput="sync('swp_withdraw', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Rate (%)</span></div><div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('swp_rate_num', -0.25)">-</button><input type="number" class="input-field" id="swp_rate_num" value="8.00" step="0.01" oninput="sync('swp_rate', 'num')"><button class="step-btn" onclick="stepVal('swp_rate_num', 0.25)">+</button></div><input type="range" id="swp_rate_rng" min="1" max="20" step="0.5" value="8" oninput="sync('swp_rate', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Years</span></div><div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('swp_years_num', -1)">-</button><input type="number" class="input-field" id="swp_years_num" value="10" oninput="sync('swp_years', 'num')"><button class="step-btn" onclick="stepVal('swp_years_num', 1)">+</button></div><input type="range" id="swp_years_rng" min="1" max="40" step="1" value="10" oninput="sync('swp_years', 'rng')"></div>
        </div>
        <div class="panel">
            <div class="panel-title">Cash Flow</div>
            <div class="summary-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="stat-card"><span class="stat-label">Withdrawn</span><span class="stat-value text-green" id="swp_total_withdrawn">0</span></div>
                <div class="stat-card"><span class="stat-label">Balance</span><span class="stat-value text-purple" id="swp_final_bal">0</span></div>
                <div class="stat-card"><span class="stat-label">Interest</span><span class="stat-value" id="swp_interest">0</span></div>
            </div>
            <div class="chart-container"><canvas id="swpChart"></canvas></div>
            <div class="table-scroll"><table id="swp_table"></table></div>
        </div>
    </div>

    <div id="lumpsum" class="calc-grid">
        <div class="panel">
            <div class="panel-title">Lumpsum</div>
            <div class="input-group"><div class="label-row"><span>Amount</span></div><div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('int_amount_num', -5000)">-</button><input type="number" class="input-field" id="int_amount_num" value="100000" oninput="sync('int_amount', 'num')"><button class="step-btn" onclick="stepVal('int_amount_num', 5000)">+</button></div><input type="range" id="int_amount_rng" min="5000" max="10000000" step="5000" value="100000" oninput="sync('int_amount', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Rate (%)</span></div><div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('int_rate_num', -0.25)">-</button><input type="number" class="input-field" id="int_rate_num" value="7.00" step="0.01" oninput="sync('int_rate', 'num')"><button class="step-btn" onclick="stepVal('int_rate_num', 0.25)">+</button></div><input type="range" id="int_rate_rng" min="1" max="15" step="0.1" value="7" oninput="sync('int_rate', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Years</span></div><div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('int_years_num', -1)">-</button><input type="number" class="input-field" id="int_years_num" value="5" oninput="sync('int_years', 'num')"><button class="step-btn" onclick="stepVal('int_years_num', 1)">+</button></div><input type="range" id="int_years_rng" min="1" max="25" step="1" value="5" oninput="sync('int_years', 'rng')"></div>
            <div class="input-group"><div class="label-row"><span>Type</span></div><select id="int_type" class="custom-select" onchange="toggleFrequency(); recalcActive();"><option value="compound">Compound Interest</option><option value="simple">Simple Interest</option></select></div>
            <div class="input-group" id="freq_group"><div class="label-row"><span>Frequency</span></div><select id="int_freq" class="custom-select" onchange="recalcActive()"><option value="1">Yearly</option><option value="2">Half-Yearly</option><option value="4">Quarterly</option><option value="12">Monthly</option></select></div>
        </div>
        <div class="panel">
            <div class="panel-title">Maturity</div>
            <div class="summary-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="stat-card"><span class="stat-label">Maturity</span><span class="stat-value text-purple" id="int_final">0</span></div>
                <div class="stat-card"><span class="stat-label">Principal</span><span class="stat-value" id="int_principal_disp">0</span></div>
                <div class="stat-card"><span class="stat-label">Interest</span><span class="stat-value text-green" id="int_gains_disp">0</span></div>
            </div>
            <div class="chart-container"><canvas id="intChart"></canvas></div>
            <div class="table-scroll"><table id="int_table"></table></div>
        </div>
    </div>

    <div id="trade" class="calc-grid">
        <div class="panel">
            <div class="panel-title">Trade Config</div>
            <div class="input-group"><div class="label-row"><span>Buy</span></div><div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('trade_buy', -1)">-</button><input type="number" class="input-field" id="trade_buy" value="100" oninput="recalcActive()"><button class="step-btn" onclick="stepVal('trade_buy', 1)">+</button></div></div>
            <div class="input-group"><div class="label-row"><span>Sell</span></div><div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('trade_sell', -1)">-</button><input type="number" class="input-field" id="trade_sell" value="115" oninput="recalcActive()"><button class="step-btn" onclick="stepVal('trade_sell', 1)">+</button></div></div>
            <div class="input-group"><div class="label-row"><span>Qty</span></div><div class="stepper-wrapper"><button class="step-btn" onclick="stepVal('trade_qty', -10)">-</button><input type="number" class="input-field" id="trade_qty" value="50" oninput="recalcActive()"><button class="step-btn" onclick="stepVal('trade_qty', 10)">+</button></div></div>
        </div>
        <div class="panel">
            <div class="panel-title">P&L Report</div>
            <div class="summary-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="stat-card"><span class="stat-label">Net P&L</span><span class="stat-value" id="trade_pnl">0</span></div>
                <div class="stat-card"><span class="stat-label">Turnover</span><span class="stat-value" id="trade_turnover">0</span></div>
                <div class="stat-card"><span class="stat-label">ROI</span><span class="stat-value" id="trade_roi">0%</span></div>
            </div>
            <div class="chart-container"><canvas id="tradeChart"></canvas></div>
        </div>
    </div>

</div>

<script>
    /* --- CONFIG & STATE --- */
    let customPayments = { re: [], loan: [] };
    let strategies = { re: 'tenure', loan: 'tenure' }; 
    let smartFreq = 'monthly';
    let charts = { sip: null, loan: null, swp: null, re: null, int: null, trade: null, smart: null };
    const formatMoney = (num) => num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

    /* --- HELPERS --- */
    function safeSet(id, val) { const el = document.getElementById(id); if (el) { if (el.tagName === 'INPUT' || el.tagName === 'SELECT') el.value = val; else el.innerText = val; } }
    function safeGet(id) { const el = document.getElementById(id); return el ? (parseFloat(el.value) || 0) : 0; }

    /* --- STEPPER LOGIC --- */
    function stepVal(id, step) {
        const el = document.getElementById(id);
        let val = parseFloat(el.value) || 0;
        val += step;
        if(val < 0) val = 0;
        if(step % 1 !== 0) el.value = val.toFixed(1); else el.value = val.toFixed(0);
        el.dispatchEvent(new Event('input')); 
    }
    
    function toggleAddCharges() {
        const content = document.getElementById('add_charges_content');
        const icon = document.getElementById('add_charge_icon');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.innerText = '-';
        } else {
            content.style.display = 'none';
            icon.innerText = '+';
        }
    }

    /* --- INIT --- */
    window.onload = function() { calculateRealEstate('cost'); }
    function toggleTheme() { const h=document.documentElement; const c=h.getAttribute('data-theme'); const n=c==='dark'?'light':'dark'; h.setAttribute('data-theme', n); localStorage.setItem('theme', n); recalcActive(); }
    (function initTheme(){ const s=localStorage.getItem('theme')||'light'; document.documentElement.setAttribute('data-theme', s); })();

    /* --- NAV --- */
    function switchTab(id) {
        document.querySelectorAll('.calc-grid').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('btn_'+id).classList.add('active');
        recalcActive();
    }
    
    function recalcActive() {
        if(document.getElementById('smartplan').classList.contains('active')) calculateSmartPlan('base');
        else if(document.getElementById('realestate').classList.contains('active')) calculateRealEstate();
        else if(document.getElementById('loan').classList.contains('active')) calculateLoan();
        else if(document.getElementById('sip').classList.contains('active')) calculateSIP();
        else if(document.getElementById('swp').classList.contains('active')) calculateSWP();
        else if(document.getElementById('lumpsum').classList.contains('active')) calculateInterest();
        else if(document.getElementById('trade').classList.contains('active')) calculateTrade();
    }

    /* --- INPUT SYNC --- */
    function sync(idBase, source) {
        const num = document.getElementById(idBase + '_num'); const rng = document.getElementById(idBase + '_rng');
        if(num && rng) { if(source === 'rng') num.value = rng.value; else rng.value = num.value; }
        recalcActive();
    }

    function syncDP(source) {
        const sft = safeGet('re_sft'); const price = safeGet('re_price_sft');
        const extraSft = safeGet('re_cost_corner') + safeGet('re_cost_facing') + safeGet('re_cost_floor');
        const extraFixed = safeGet('re_cost_amenities') + safeGet('re_cost_corpus');
        const total = (sft * (price + extraSft)) + extraFixed;
        
        if(total===0) return;
        const amtEl = document.getElementById('re_dp_amt'); const rngEl = document.getElementById('re_dp_rng'); const perEl = document.getElementById('re_dp_percent');
        const disp = document.getElementById('re_dp_percent_disp');

        if(source==='amt') {
            let p=(safeGet('re_dp_amt')/total)*100; if(p>99)p=99;
            if(perEl) perEl.value=p.toFixed(2); 
            if(rngEl) rngEl.value=p; 
            if(disp) disp.innerText=p.toFixed(2);
        } else {
            let p = source==='rng' ? (rngEl?rngEl.value:20) : (perEl?perEl.value:20);
            if(rngEl) rngEl.value=p; if(perEl) perEl.value=p; 
            if(disp) disp.innerText=parseFloat(p).toFixed(2);
            if(amtEl) amtEl.value=(total*(p/100)).toFixed(0);
        }
        calculateRealEstate();
    }

    function updateReLabels() {
        const u = document.getElementById('re_unit_type').value;
        const labels = {sft: 'Sq.Ft', syd: 'Sq.Yd', sm: 'Sq.M', acre: 'Acre'};
        document.getElementById('re_area_lbl').innerText = 'Area (' + labels[u] + ')';
        document.getElementById('re_price_lbl').innerText = 'Price / ' + labels[u];
    }

    /* --- PAYMENTS --- */
    function setStrategy(type, strat) {
        strategies[type] = strat;
        const btnTenure = document.getElementById(type+'_strat_tenure');
        const btnEmi = document.getElementById(type+'_strat_emi');
        if(btnTenure) btnTenure.classList.toggle('selected', strat==='tenure');
        if(btnEmi) btnEmi.classList.toggle('selected', strat==='emi');
        recalcActive();
    }
    function addPayment(type) {
        const a=safeGet(type+'_part_amt'); const y=parseInt(document.getElementById(type+'_part_year').value)||0;
        if(!a||!y) return alert("Invalid amount/year");
        customPayments[type].push({amt:a, year:y});
        safeSet(type+'_part_amt',''); safeSet(type+'_part_year','');
        renderPayments(type); recalcActive();
    }
    function removePayment(type, i) { customPayments[type].splice(i,1); renderPayments(type); recalcActive(); }
    function renderPayments(type) {
        const c=document.getElementById(type+'_payments_list'); if(!c) return;
        c.innerHTML='';
        customPayments[type].sort((a,b)=>a.year-b.year).forEach((p,i)=>{
            c.innerHTML+=`<div class="tag"><span>Yr ${p.year}: ${formatMoney(p.amt)}</span><span class="tag-close" onclick="removePayment('${type}',${i})">‚úï</span></div>`;
        });
    }
    function getPrepay(type, yr) { return customPayments[type].filter(p=>p.year===yr).reduce((s,p)=>s+p.amt,0); }

    /* --- CHART --- */
    function updateChart(id, cvs, lbls, d1, l1, c1, d2, l2, c2, d3, l3, c3, d4, l4, c4) {
        const el = document.getElementById(cvs); if(!el) return;
        const ctx=el.getContext('2d');
        if(charts[id]) charts[id].destroy();
        const isDark=document.documentElement.getAttribute('data-theme')==='dark';
        const txt=isDark?'#94A3B8':'#6B7280'; const grd=isDark?'#334155':'#E5E7EB';
        let ds = [];
        let grad1=ctx.createLinearGradient(0,0,0,400); grad1.addColorStop(0,c1); grad1.addColorStop(1,c1+'00');
        ds.push({label:l1, data:d1, borderColor:c1, backgroundColor:grad1, tension:0.4, fill:true, borderWidth:2, pointRadius:0});
        if(d2) ds.push({label:l2, data:d2, borderColor:c2, backgroundColor:c2+'10', tension:0.4, fill:true, borderWidth:2, pointRadius:0, borderDash:[5,5]});
        if(d3) ds.push({label:l3, data:d3, borderColor:c3, backgroundColor:c3+'10', tension:0.4, fill:true, borderWidth:2, pointRadius:0});
        if(d4) ds.push({label:l4, data:d4, borderColor:c4, backgroundColor:'transparent', tension:0.4, fill:false, borderWidth:2, pointRadius:0, borderDash:[2,2]});

        charts[id]=new Chart(ctx,{type:'line', data:{labels:lbls, datasets:ds}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:txt,font:{family:'Plus Jakarta Sans'}}}, tooltip:{mode:'index', intersect:false}}, scales:{x:{ticks:{color:txt}, grid:{color:grd, drawBorder:false}}, y:{ticks:{color:txt, callback:v=>v>=1000?v/1000+'k':v}, grid:{color:grd, drawBorder:false}}}}});
    }

    /* --- TABLE --- */
    function renderTable(id, h, r) {
        const el = document.getElementById(id); if(!el) return;
        let ht=`<thead><tr>`; h.forEach(x=>ht+=`<th>${x}</th>`); ht+=`</tr></thead><tbody>`;
        r.forEach(x=>{
            let cls=x.pre?'class="hl-row"':'';
            ht+=`<tr ${cls}>`; x.d.forEach((c,i)=>{ let v=c; if(i===3&&x.pre) v+=`<div style="font-size:0.75rem; color:var(--success); font-weight:700">+${formatMoney(x.preVal)}</div>`; ht+=`<td>${v}</td>`; }); ht+=`</tr>`;
        });
        el.innerHTML=ht+`</tbody>`;
    }

    /* --- SMART PLAN CALC --- */
    function setSmartFreq(mode) {
        smartFreq = mode;
        document.getElementById('smart_freq_monthly').classList.toggle('selected', mode==='monthly');
        document.getElementById('smart_freq_yearly').classList.toggle('selected', mode==='yearly');
        document.getElementById('smart_amt_label').innerText = mode==='monthly' ? 'Monthly Investment' : 'Yearly Investment';
        calculateSmartPlan('base');
    }
    function calculateSmartPlan(source) {
        if(source.includes('amount')) { const n=document.getElementById('smart_plan_amount_num'); const r=document.getElementById('smart_plan_amount_rng'); if(source==='amount_rng')n.value=r.value; else r.value=n.value; }
        if(source.includes('rate')) { const n=document.getElementById('smart_plan_rate_num'); const r=document.getElementById('smart_plan_rate_rng'); if(source==='rate_rng')n.value=r.value; else r.value=n.value; }

        const amt = safeGet('smart_amt_num');
        const invYears = safeGet('smart_inv_yrs_num');
        const waitYears = safeGet('smart_wait_yrs_num');
        const rateMF = safeGet('smart_mf_rate_num');
        safeSet('smart_total_dur', invYears + waitYears);
        
        const periodsPerYear = smartFreq==='monthly' ? 12 : 1;
        const totalPeriodsInv = invYears * periodsPerYear;
        const totalPeriodsWait = waitYears * periodsPerYear; 
        let ratePlan = safeGet('smart_plan_rate_num');
        let targetPlanAmount = safeGet('smart_plan_amount_num');

        if (source.includes('amount') && targetPlanAmount > 0) {
            ratePlan = findRateSmart(amt, totalPeriodsInv, totalPeriodsWait, targetPlanAmount, periodsPerYear);
            safeSet('smart_plan_rate_num', ratePlan.toFixed(2));
            document.getElementById('smart_plan_rate_rng').value = ratePlan.toFixed(2);
        } else {
            targetPlanAmount = calculateCorpusSmart(amt, totalPeriodsInv, totalPeriodsWait, ratePlan, periodsPerYear);
            safeSet('smart_plan_amount_num', targetPlanAmount.toFixed(0));
            document.getElementById('smart_plan_amount_rng').value = targetPlanAmount;
        }

        let corpusMF = calculateCorpusSmart(amt, totalPeriodsInv, totalPeriodsWait, rateMF, periodsPerYear);
        let totalInv = amt * totalPeriodsInv;

        safeSet('smart_invested', formatMoney(totalInv));
        safeSet('smart_plan_val', formatMoney(targetPlanAmount));
        safeSet('smart_mf_val', formatMoney(corpusMF));
        safeSet('smart_gap', formatMoney(corpusMF - targetPlanAmount));

        generateSmartChart(amt, totalPeriodsInv, totalPeriodsWait, ratePlan, rateMF, periodsPerYear, invYears);
    }
    function calculateCorpusSmart(amt, invP, waitP, rate, freq) {
        let corpus = 0; let r = rate / (100 * freq); 
        for(let i=0; i<invP; i++) corpus = (corpus + amt) * (1 + r);
        for(let i=0; i<waitP; i++) corpus = corpus * (1 + r); 
        return corpus;
    }
    function findRateSmart(amt, invP, waitP, target, freq) {
        let low = 0, high = 100;
        for(let i=0; i<50; i++) {
            let mid = (low+high)/2;
            if(calculateCorpusSmart(amt, invP, waitP, mid, freq) > target) high = mid; else low = mid;
        }
        return low;
    }
    function generateSmartChart(amt, invP, waitP, rPlan, rMF, freq, invYrs) {
        let labels = ['Start'];
        let dInv = [0]; let dPlan = [0]; let dMF = [0];
        let cPlan = 0, cMF = 0, cInv = 0;
        let rateP = rPlan / (100 * freq); let rateM = rMF / (100 * freq);
        for(let i=1; i<=invP; i++) {
            cPlan = (cPlan + amt) * (1 + rateP); cMF = (cMF + amt) * (1 + rateM); cInv += amt;
            if(i % freq === 0) { labels.push('Yr ' + i/freq); dInv.push(cInv); dPlan.push(cPlan); dMF.push(cMF); }
        }
        for(let i=1; i<=waitP; i++) {
            cPlan = cPlan * (1 + rateP); cMF = cMF * (1 + rateM);
            if(i % freq === 0) { labels.push('Yr ' + (invYrs + i/freq)); dInv.push(cInv); dPlan.push(cPlan); dMF.push(cMF); }
        }
        updateChart('smart', 'smartChart', labels, dInv, 'Invested', '#9CA3AF', dPlan, 'Traditional Plan', '#6366F1', dMF, 'Mutual Fund', '#10B981');
    }

    /* --- REAL ESTATE CALC --- */
    function calculateRealEstate(src) {
        const sft = safeGet('re_sft'); 
        const price = safeGet('re_price_sft'); 
        const extraSft = safeGet('re_cost_corner') + safeGet('re_cost_facing') + safeGet('re_cost_floor');
        const extraFixed = safeGet('re_cost_amenities') + safeGet('re_cost_corpus');
        const cost = (sft * (price + extraSft)) + extraFixed;

        if(src==='cost') { 
            let p = safeGet('re_dp_percent') || 20; 
            safeSet('re_dp_amt', (cost*(p/100)).toFixed(0)); 
        }
        if(safeGet('re_dp_amt') === 0 && cost > 0) safeSet('re_dp_amt', (cost*0.2).toFixed(0));
        
        const dp = safeGet('re_dp_amt'); 
        const loan = cost - dp;
        const yrs = safeGet('re_tenure_num') || 20;
        const rate = safeGet('re_rate_num'); const r = rate/1200; const n = yrs*12; 
        const yieldPercent = safeGet('re_yield_num');
        
        let emi = 0; if(r>0) emi=loan*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1);

        safeSet('re_total_cost', formatMoney(cost));
        safeSet('re_loan_amt', formatMoney(loan));
        safeSet('re_emi_input', formatMoney(emi));
        safeSet('re_emi', formatMoney(emi));
        
        genSchedule(loan, emi, r, yrs, 're', cost, 're_table', 'reChart', emi*n, yieldPercent);
    }
    
    function calculateLoan() {
        const loan=safeGet('loan_amount_num'); const rate=safeGet('loan_rate_num'); const yrs=safeGet('loan_years_num');
        const r=rate/1200; const n=yrs*12;
        let emi=0; if(r>0&&n>0) emi=loan*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1);
        safeSet('loan_emi_input', formatMoney(emi)); safeSet('loan_emi', formatMoney(emi));
        genSchedule(loan, emi, r, yrs, 'loan', 0, 'loan_table', 'loanChart', emi*n, 0);
    }

    function genSchedule(P, emi, r, yrs, type, cost, tid, cid, origTotal, rentalYield) {
        let bal=P; let paid=0; let mElapsed=0; let closed=false; let currentEMI = emi;
        let lbls=['Start']; let dBal=[P]; let dVal=[cost]; let cVal=cost; let dWealth = [cost]; 
        let dInt = [0]; let accumRent = 0; let accumInt = 0;
        let rows=[]; let strategy = strategies[type]; 

        for(let y=1; y<=yrs; y++){
            let pre=getPrepay(type, y);
            for(let m=1; m<=12; m++){
                if(bal<=0) { closed=true; break; }
                let int=bal*r; let prin=currentEMI-int; 
                if(bal<prin) { prin=bal; int=0; closed=true; }
                bal-=prin; paid+=currentEMI; mElapsed++;
                accumInt += int;

                let row={m:(y-1)*12+m, emi:currentEMI, i:int, p:prin, b:bal, pre:0, totInt: accumInt};
                
                if(m===12 && pre>0 && !closed){
                    if(bal<pre) pre=bal;
                    bal-=pre; paid+=pre; row.pre=pre; row.b=bal;
                    if(bal<=0) closed=true;
                    if(strategy === 'emi' && !closed) {
                        let remMonths = (yrs*12) - mElapsed;
                        if(remMonths > 0) currentEMI = (bal * r * Math.pow(1+r, remMonths)) / (Math.pow(1+r, remMonths) - 1);
                    }
                }
                rows.push(row);
                if(closed) break;
            }
            lbls.push('Yr '+y); dBal.push(bal<0?0:bal); dInt.push(accumInt);
            if(type==='re'){ 
                cVal*=1.05; dVal.push(cVal); 
                let yearlyRent = cVal * (rentalYield/100);
                accumRent += yearlyRent;
                dWealth.push(cVal + (accumRent * 2));
            }
        }

        let allInt = rows.reduce((s,x)=>s+x.i,0); let run=0; let tableData = [];
        rows.forEach(x=>{
            let rem = allInt-run-x.i; run+=x.i;
            tableData.push({ d:[x.m, formatMoney(x.emi), formatMoney(x.i), formatMoney(x.p+x.pre), formatMoney(x.b), formatMoney(x.totInt)], pre:x.pre>0, preVal:x.pre });
        });
        renderTable(tid, ['Month', 'EMI', 'Interest', 'Principal+Pre', 'Balance', 'Tot. Int.'], tableData);

        let saved = origTotal-paid; let timeSave = (yrs*12-mElapsed)/12;
        safeSet(type+'_saved', saved>0?formatMoney(saved):"0");
        safeSet(type+'_time_saved', timeSave>0?timeSave.toFixed(1)+" Yrs":"0 Yrs");
        if(type==='loan') safeSet('loan_total_pay', formatMoney(paid));
        
        if(type==='re') {
            safeSet('re_rent_val', formatMoney(cVal + (accumRent * 2)));
            updateChart(type, cid, lbls, dWealth, 'Wealth (Prop + 2x Rent)', '#10B981', dBal, 'Loan Balance', '#EF4444', dVal, 'Prop Value', '#8B5CF6', dInt, 'Total Interest', '#F59E0B');
        } else {
            updateChart(type, cid, lbls, dBal, 'Loan Balance', '#6366F1', dInt, 'Total Interest', '#F59E0B');
        }
    }

    /* --- SIP/SWP/LUMP/TRADE --- */
    function calculateSIP(){
        const monthly=safeGet('sip_amount_num'); const rate=safeGet('sip_rate_num'); const years=safeGet('sip_years_num');
        const st=document.getElementById('sip_stepup_check').checked; const sv=safeGet('sip_step_val'); const type=document.getElementById('sip_step_type').value;
        let tot=0; let val=0; let cur=monthly; const mr=rate/1200; let l=[], dV=[], dI=[], rows=[];
        for(let m=1;m<=years*12;m++){
            val=(val+cur)*(1+mr); tot+=cur;
            if(st&&m%12==0&&m<years*12){ if(type=='percent')cur*=1+sv/100; else cur+=sv; }
            if(m%12==0){ let yr=m/12; l.push('Yr '+yr); dV.push(val); dI.push(tot); rows.push({d:['Yr '+yr, formatMoney(tot), formatMoney(val)]}); }
        }
        safeSet('sip_total', formatMoney(val)); safeSet('sip_invested', formatMoney(tot)); safeSet('sip_gains', formatMoney(val-tot));
        updateChart('sip','sipChart',l,dV,'Value','#6366F1',dI,'Invested','#9CA3AF'); renderTable('sip_table',['Year','Invested','Value'],rows);
    }
    function setStepType(t){ document.getElementById('sip_step_type').value=t; document.getElementById('step_type_percent').classList.toggle('selected', t==='percent'); document.getElementById('step_type_value').classList.toggle('selected', t==='value'); calculateSIP(); }
    function toggleStepUp(){ document.getElementById('stepup_panel').style.display=document.getElementById('sip_stepup_check').checked?'block':'none'; calculateSIP(); }

    function calculateSWP(){
        const c=safeGet('swp_amount_num'); const w=safeGet('swp_withdraw_num'); const r=safeGet('swp_rate_num'); const y=safeGet('swp_years_num');
        let bal=c, tw=0, ti=0, l=['Start'], dB=[c], dW=[0], rows=[];
        for(let m=1;m<=y*12;m++){
            let i=bal*r/1200; ti+=i; bal+=i; let aw=w; if(bal<w){ aw=bal; bal=0; } else bal-=w; tw+=aw;
            if(m%12==0){ l.push('Yr '+m/12); dB.push(bal); dW.push(tw); rows.push({d:['Yr '+m/12, formatMoney(tw), formatMoney(bal)]}); }
            if(bal<=0)break;
        }
        safeSet('swp_total_withdrawn', formatMoney(tw)); safeSet('swp_final_bal', formatMoney(bal)); safeSet('swp_interest', formatMoney(ti));
        updateChart('swp','swpChart',l,dB,'Balance','#6366F1',dW,'Withdrawn','#10B981'); renderTable('swp_table',['Year','Withdrawn','Balance'],rows);
    }

    function calculateInterest(){
        const p=safeGet('int_amount_num'); const r=safeGet('int_rate_num'); const y=safeGet('int_years_num');
        const typ=document.getElementById('int_type').value; const fr=parseFloat(document.getElementById('int_freq').value)||1;
        let l=[], d=[], rows=[];
        for(let i=1;i<=y;i++){
            let v=typ=='simple'?p+(p*r*i/100):p*Math.pow(1+(r/(100*fr)), fr*i);
            l.push('Yr '+i); d.push(v); rows.push({d:['Yr '+i, formatMoney(p), formatMoney(v)]});
        }
        let f=d[d.length-1]; safeSet('int_final', formatMoney(f)); safeSet('int_principal_disp', formatMoney(p)); safeSet('int_gains_disp', formatMoney(f-p));
        updateChart('int','intChart',l,d,'Maturity','#10B981'); renderTable('int_table',['Year','Principal','Value'],rows);
    }
    function toggleFrequency(){ document.getElementById('freq_group').style.display=document.getElementById('int_type').value=='compound'?'block':'none'; recalcActive(); }

    function calculateTrade(){
        const b=safeGet('trade_buy'); const s=safeGet('trade_sell'); const q=safeGet('trade_qty');
        const p=(s-b)*q; safeSet('trade_pnl', formatMoney(p)); safeSet('trade_turnover', formatMoney((b+s)*q)); safeSet('trade_roi', (b>0?p/(b*q)*100:0).toFixed(2)+'%');
        let l=[], d=[], st=s*0.05, start=s*0.75; for(let i=0;i<=10;i++){ let pr=start+(st*i); l.push(pr.toFixed(1)); d.push((pr-b)*q); }
        updateChart('trade','tradeChart',l,d,'P&L','#6366F1');
    }
</script>
</body>
</html>
